---
title: "ANOVA"
author: "Katie Lankowicz"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Delete old data
rm(list=ls())

# Load packages, install nycflights13, rstatix, corrplot if you need to.
library(here)
library(tidyverse)
library(palmerpenguins)
library(rstatix)
```

## Analysis of Variance (ANOVA)
Chi-square tests of independence, which we worked on last lesson, determine association between two categorical variables, each with multiple (2 or more) levels. What if we want to test the relationship between a categorical variable with many (3 or more) levels and a quantitative variable? For that, we would use Analysis of Variance (or ANOVA) tests. We'll go back to using the `palmerpenguins` dataset. Let's load it in.

```{r load-data}
penguins <- as.data.frame(palmerpenguins::penguins)
str(penguins)
```

Let's test if mean flipper length varies by penguin species (remember we have data for Adélie, Gentoo, and Chinstrap penguins). We'll use species as the explanatory variable and flipper length as the response variable. Species is a categorical variable. Flipper length is a numeric variable. We'll start by looking at how much data we have to play with.

```{r assess-data}
summary(penguins)
```

The idea behind the ANOVA test is very simple: if the average variation between groups (variation in flipper length between species) is large enough compared to the average variation within groups (variation in flipper length within species), then you could conclude that at least one group mean is not equal to the others. Thus, it’s possible to evaluate whether the differences between the group means are significant by comparing the two variance estimates. This is why the method is called analysis of variance even though the main goal is to compare the group means.

### Assumptions
We need to think about the requirements and assumptions of ANOVA. They are:

* One continuous numeric response variable and one categorical explanatory variable
* Independence of data points
* No significant outliers in any group
* Normality of residuals OR many samples (>30 per group)
* Equality of variance 

First of all, we've already confirmed that we are interested in comparing a quantitative response variable across levels of a categorical explanatory variable. 

ANOVA also requires independence of observations. Like last time, we will assume that the researchers sampled an entirely new set of penguins each year, not the same penguins every year of the survey. We will check for outliers before performing the test and remove any extreme outliers. We don't have to worry about normality a lot, since we have more than 30 observations per group, but we'll assess the normality of our data anyway. We will save checking normality and equality of variance for when we have residuals from our model. By waiting until we have residuals, we can look at normality and variance for all groups together. This is easier than checking normality and variance for each group separately, which we would have to do if we weren't using residuals.

We will begin by doing some light data cleaning, then check for outliers.

```{r check-assumptions}
# Clean data-- keep only variables we care about for this test.
penguins2 <- dplyr::select(penguins,
                          species, flipper_length_mm)

# Check for and remove missing values
summary(penguins2)

penguins2 <- penguins2 %>% 
  drop_na()

# Qualitatively check for outliers
ggplot(data=penguins2, aes(x=species, y=flipper_length_mm))+
  geom_boxplot()
# Boxplot indicates many outliers

# Quantitatively check for outliers
outlier.check <- penguins2 %>% 
  group_by(species) %>%
  identify_outliers(flipper_length_mm)
nrow(outlier.check[outlier.check$is.extreme==TRUE,])
# Though we have two outliers in the Adélie penguin group, they are not extreme.
# We will keep them.

```

We have addressed our outliers. We also made a boxplot, which shows the center and spread of flipper length values per species group. Judging by eye, it looks like Adélie and Chinstrap penguins have similar flipper lengths, but Gentoos have much longer flippers than the other two. Let's set up our ANOVA model to make a quantitative determination of the difference in mean flipper length between these three species

```{r anova}
# Run ANOVA
res_aov <- aov(flipper_length_mm ~ species,
  data = penguins2
)

# View results
summary(res_aov)

```

We now have our outcome. The p-value column shows us that the mean flipper length is significantly different between the levels of species (Adélie, Chinstrap, Gentoo). To quantitatively determine which species are significantly different to each other, we need to run a "post-hoc" (after the fact) test.

```{r posthoc}
# Run Tukey's post-hoc test to determine which species are different
TukeyHSD(res_aov, conf.level = 0.95)

# Plot pairwise comparisons
plot(TukeyHSD(res_aov))
```

Both the post-hoc test and the plot show us the same thing: it looks like all possible pairs of species comparisons are significantly different. 

The text output is organized so that each row is a possible pairing of species. The `diff` column shows the estimated difference between the mean flipper lengths of the two species being compared. The `lwr` and `uppr` columns show the bounds of the 95% confidence interval around the estimated difference in means. Note that if this confidence interval included 0, it would be an indication that there is no significant difference in means between the two species being compared. The final column gives the adjusted p-value of this comparison. Since all species pairs have very low p-values, all species have mean flipper lengths significantly different to each other.

Let's go back and address the assumptions of normality and equality of variance, starting with normality.

```{r assumptions-normality}
# Plot model residuals in a QQ plot
plot(res_aov, 2)

# Quantitative tests of normality
shapiro.test(res_aov$residuals)
```

We already knew that since we have more than 30 samples per group, normality is not a huge concern for us. Regardless, the QQ plot and Shapiro-Wilk test gave us confirmation that are data are normally distributed. Let's move on to equality of variance.

```{r assumptions-variance}
# Plot distribution of residuals
plot(res_aov, 1)

# Quantitative determination of equality of variance
# The null hypothesis is that all groups have equal variance. The alternative hypothesis is that at least one group has significantly different variance. We'll use a confidence level of 95%.
levene_test(flipper_length_mm ~ species, data=penguins2)
```

Both the Levene test and the residuals plot indicate that there is no evidence that the variance is unequal across the range of our variables. So that's great! We can conclude that Adélie, Gentoo, and Chinstrap penguins have significantly different mean flipper lengths.

## Wrapup
In this lesson, we learned about quantifying relationships between explanatory categorical variables and response numeric variables using Analysis of Variance (ANOVA) tests. Please take these concepts to your own data. Before you do anything else, you should always explore your data and visualize it to see if there are any obvious problems or patterns to address.